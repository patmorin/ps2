\documentclass{patmorin}
\listfiles
\usepackage{pat}
\usepackage{paralist}
\usepackage{dsfont}  % for \mathds{A}
\usepackage[utf8x]{inputenc}
\usepackage{skull}
\usepackage{paralist}
\usepackage{graphicx}
\usepackage[noend]{algorithmic}

\usepackage[normalem]{ulem}
\usepackage{cancel}
\usepackage{enumitem}

\usepackage{todonotes}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

\newcommand{\Rho}{\mathrm{P}}

% \newcommand{\harpoon}{\overset{\rightharpoonup}}
\newcommand{\qa}{\overset{\rightharpoonup}{\varphi}}
\newcommand{\qb}{\overset{\rightharpoondown}{\varphi}}
\newcommand{\qap}{\overset{\rightharpoonup}{\sigma}}
\newcommand{\qbp}{\overset{\rightharpoondown}{\sigma}}

\usepackage[mathlines]{lineno}
\setlength{\linenumbersep}{2em}
% \linenumbers
% \rightlinenumbers
% \linenumbers
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
 \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
 \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
 \renewenvironment{#1}%
    {\linenomath\csname old#1\endcsname}%
    {\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
 \patchAmsMathEnvironmentForLineno{#1}%
 \patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
\patchBothAmsMathEnvironmentsForLineno{equation}%
\patchBothAmsMathEnvironmentsForLineno{align}%
\patchBothAmsMathEnvironmentsForLineno{flalign}%
\patchBothAmsMathEnvironmentsForLineno{alignat}%
\patchBothAmsMathEnvironmentsForLineno{gather}%
\patchBothAmsMathEnvironmentsForLineno{multline}%
}


\newcommand{\coloured}[2]{{\color{#1}{#2}}}
\newenvironment{colourblock}[1]{\color{#1}}{}

\newcommand{\condref}[1]{(C\ref{#1})}

% Taken from
% https://tex.stackexchange.com/questions/42726/align-but-show-one-equation-number-at-the-end
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}


\setlength{\parskip}{1ex}


\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\lca}{lca}

\DeclareMathOperator{\x}{x}
\DeclareMathOperator{\height}{height}
\DeclareMathOperator{\depth}{depth}
\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\sh}{cbt}
\DeclareMathOperator{\cbt}{cbt}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\dc}{dc}

\title{\MakeUppercase{An Optimal Algorithm for Product Structure in Planar Graphs}\thanks{This research was partly funded by NSERC.}}
\author{%
  Prosenjit Bose\thanks{School of Computer Science, Carleton University}\qquad
  Vida Dujmović\thanks{Department of Computer Science and Electrical Engineering, University of Ottawa}\qquad
  Pat Morin\footnotemark[1]\qquad
  Saeed Odak\footnotemark[2]}
    % }

\date{}


\newcommand{\colored}[2]{{\color{#1}#2}}

\usepackage{tabularx}


\begin{document}

% \begin{titlepage}
\maketitle

\begin{abstract}
  The Product Structure Theorem for planar graphs (Dujmović et al, 2019) states that any planar graph is contained in strong product of a planar $3$-tree, a path, and $3$-cycle.  We give a simple linear-time algorithm for finding this decomposition as well as several related decompositions.  This improves upon the previous $O(n\log n)$ time algorithm (Morin, \emph{Algorithmica}. \textbf{85}(5):1544--1558).
\end{abstract}
% \end{titlepage}

% \pagenumbering{roman}
% \tableofcontents
%
% \newpage
% \pagenumbering{arabic}

\section{Introduction}

For two graph $G$ and $X$, the notation $G\subseteq X$ denotes that $G$ is isomorphic to some subgraph of $X$.
% Throughout this paper, $P$ denotes the \emph{one way infinite path}, i.e., the path with vertex set $V(P):=\N$ and edge set $E(P):=\{\{i,i+1\}:i\in\N\}$.
The following \emph{planar product structure theorems} have recently been used as a key tool in resolving a number of longstanding open problems on planar graphs \cite{dujmovic.esperet.ea:adjacency,dujmovic.joret.ea:planar,dujmovic.esperet.ea:planar,debski.felsner.ea:improved}.

\begin{thm}[\citet{dujmovic.joret.ea:planar, ueckerdt.wood.ea:improved}]\label{meta}
  For any planar graph $G$, there exists:
  \begin{compactenum}[(a)]
    \item \label{three_tree} a planar graph $H$ of treewidth at most $3$ and a path $P$ such that $G\subseteq H\boxtimes P\boxtimes K_3$ \cite{dujmovic.joret.ea:planar};
    \item a planar graph $H$ of treewidth at most $4$ and a path $P$ such that $G\subseteq H\boxtimes P\boxtimes K_2$; and
    \item a planar graph $H$ of treewidth at most $6$ and a path $P$ such that $G\subseteq H\boxtimes P$ \cite{ueckerdt.wood.ea:improved}.
  \end{compactenum}
\end{thm}

(In this paper, we will not be working directly with treewidth or the strong graph product ($\boxtimes$), so we omit their definitions.\todo{Put the defn's in a footnote?})

The proofs of each part of \cref{meta} are constructive and lead to $O(n^2)$ time algorithms as observed already by \citet{dujmovic.joret.ea:planar}.  \citet{morin:fast} later showed that there exists an $O(n\log n)$ time algorithm to find the decomposition in \cref{meta}.\ref{three_tree}.  In the current note, we show that there exists a linear time algorithm for finding each of the three decompositions guaranteed by \cref{meta}.


\section{Preliminaries}

Throughout this paper we use standard graph theory terminology as used in the textbook by Diestel \cite{diestel:graph}.  All graphs discussed here are simple and finite.  For a graph $G$, $V(G)$ and $E(G)$ denote the vertex and edge sets of $G$, respectively.

\paragraph{Quotient Graphs.}

Given a graph $G$ and a partition $\mathcal{P}$ of $V(G)$, the \emph{quotient graph} $H:=G/\mathcal{P}$ is the graph whose vertex set $V(H):=\mathcal{P}$ contains one one for each part in $\mathcal{P}$ and in which two nodes $X,Y\in V(H)$ are adjacent if $G$ contains at least one edge $xy$ with $x\in X$ and $y\in Y$.

\paragraph{Embeddings, Planar Graphs, and (Near-)Triangulations.}

An \emph{embedding} $\psi$ of a graph $G$ associates each vertex $v$ of $G$ with a point $\psi(v)\in \R^2$ and each edge $vw$ of $G$ with a simple open curve $\psi(vw):(0,1)\to\R^2$ whose endpoints\footnote{The \emph{endpoints} of an open curve $\psi:(0,1)\to\R^2$ are the two points $\lim_{\epsilon\downarrow 0} \psi(\epsilon)$ and $\lim_{\epsilon\downarrow 0}\psi(1-\epsilon)$.} are $\psi(v)$ and $\psi(w)$.  (We do not distinguish between such a curve $\psi(vw)$ and the point set $\{\psi(vw)(t):0<t<1\}$.)
We let $\psi(V(G)):=\{\psi(v):v\in V(G)\}$, $\psi(E(G)):=\bigcup_{vw\in E(G)} \psi(vw)$, and $\psi(G):=\psi(V(G))\cup\psi(E(G))$.  An embedding $\psi$ of $G$ is \emph{plane} if $\psi(vw)\cap\psi(V(G))=\emptyset$ and $\psi(vw)\cap\psi(xy)=\emptyset$ for each distinct pair of edges $vw,xy\in E(G)$.  A graph $G$ is \emph{planar} if it has an plane embedding. A \emph{triangulation} is an edge-maximal planar graph.

If $\psi$ is a plane embedding of a planar graph $G$, then we call the pair $(G,\psi)$ an \emph{embedded graph} and we will not distinguish between a vertex $v$ of $G$ and the point $\psi(v)$ or between an edge $vw$ of $G$ and the curve $\psi(vw)$.  Similarly, we will not distinguish between $G$ and the  point set $\psi(G)$.  Any cycle in an embedded graph defines a Jordan curve. For such a cycle $C$, $\R^2\setminus C$ has two components, one bounded and the other unbounded. We will refer to the bounded component as the \emph{interior} of $C$ and the unbounded component as the \emph{exterior} of $C$.  If $G$ is an embedded triangulation, then the subgraph of $G$ consisting of all edges and vertices of $G$ contained in the closure of the interior of $C$ is called a \emph{near-triangulation}.

Each component of $\R^2\setminus G$ is a \emph{face} of $G$ and we let $F(G)$ denote the set of faces of $G$.  If $G$ is $2$-connected then, for any face $f\in F(G)$, the set of vertices and edges of $G$ contained in the boundary of $f$ form a cycle.  We may therefore treat a face $f$ of a $2$-connected graph $G$ as a component of $\R^2\setminus G$ or as the cycle of $G$ on the boundary of $f$, relying on context to distinguish between the two usages.  Note that every embedded graph contains exactly one face, the \emph{outer face} that is unbounded.

\paragraph{Duals and Cotrees.}

The \emph{dual} $G^\star$ of an embedded planar graph $G$ is the graph with vertex set $V(G^\star):=F(G)$ and edge set $E(G^{\star}):=\{fg\in \binom{F(G)}{2}:E(f)\cap E(g)\neq\emptyset\}$.\footnote{For a set $S$, $\binom{S}{2}$ denotes the $\binom{|S|}{2}$-element set $\binom{S}{2}:=\{\{x,y\}:x,y\in S, x\neq y\}$.}  If $T$ is a spanning tree of an embedded triangulation $G$ then the \emph{cotree} $\overline{T}$ of $(G,T)$ is the graph $\overline{T}:=G^\star-\{ab\in E(G^*):E(a)\cap E(b)\setminus E(T)\neq\emptyset\}$.  It is well known that such a cotree is a spanning tree of $G^\star$.

\paragraph{Paths and Distances.}

A \emph{path} in $G$ is a (possibly empty) sequence of vertices $v_0,\ldots,v_r$ with the property that $v_{i-1}v_i\in E(G)$, for each $i\in\{1,\ldots,r\}$.  The \emph{endpoints} of a path $v_0,\ldots,v_r$ are the vertices $v_0$ and $v_r$.
% We will treat a path $v_0,\ldots,v_r$ interchangeably with the subgraph of $G$ having vertex set $\{v_0,\ldots,v_r\}$ and edge set $\{v_{i-1}v_i:i\in\{1,\ldots,r\}\}$.
The \emph{length} of a non-empty path $v_0,\ldots,v_r$ is the number, $r$, of edges in the path.  For two vertices $v$ and $w$ in a connected graph $G$, $\dist_G(v,w)$ denotes the minimum length of a path in $G$ that contains both $v$ and $w$.
% For a non-empty subset $S\subseteq V(G)$, $\dist_G(v,S):=\min\{\dist_G(v,w):w\in S\}$.
%

\paragraph{Trees, Depth, Ancestors, and Descendants.}

Let $T$ be a tree rooted at a vertex $v\in V(T)$.  For any vertex $w\in V(T)$, $P_T(w)$ denotes the path in $T$ from $v$ to $w$.  For any $w_0\in V(T)$, any prefix $w_0,\ldots,w_r$ of $P_T(w_0)$ is called an \emph{upward path} in $T$; $v_0$ is the \emph{lower endpoint} of this path and $v_r$ is the \emph{upper endpoint}.  The \emph{$T$-depth} of a node $w\in V(T)$ is $\depth_T(w):=\dist_T(v,w)$, i.e,. the length of the path $P_T(w)$. The second node in $P_T(v)$ (if any) is the \emph{$T$-parent} of $v$.  A vertex $a\in V(T)$ is a \emph{$T$-ancestor} of $v\in V(T)$ if $a\in V(P_T(v))$. If $a$ is a $T$-ancestor of $v$ then $v$ is a \emph{$T$-descendant} of $a$.


\paragraph{Lowest Common Ancestors}

For any two vertices $v,w\in V(T)$, the \emph{lowest common ancestor} $\lca_T(v,w)$ of $v$ and $w$ is the vertex $a$ of $P_T(v)\cap P_T(w)$ that maximizes $\depth_T(a)$.  The \emph{lowest commmon ancestor problem} is a well-studied data structuring problem that asks to preprocess a given $n$-vertex rooted tree so that one can quickly return $\lca_T(v,w)$ for any two nodes $v,w\in V(T)$. A number of optimal solutions to this problem exist that, after $O(n)$ time preprocessing using $O(n)$ space, can answer queries in $O(1)$ time \cite{berman.vishkin:recursive,shieber.vishkin:on,harel.tarjan:fast,alstrup.gavoille.ea:nearest,bender.farach-colton:lca,fischer.heun:theoretical}.  The most recent work in this area includes simple and practical data structures that achieve this optimal performance \cite{alstrup.gavoille.ea:nearest,bender.farach-colton:lca,fischer.heun:theoretical}.

% \subsection{Nearest Marked Ancestors}
%
% The \emph{nearest marked ancestor problem} is another well-studied data structuring problem that asks to preprocess an $n$-vertex rooted tree $T$ whose nodes are all initially \emph{unmarked} with the exception of the root which is \emph{marked}.  The data structure supports two operations:
% \begin{inparaenum}[(i)]
%     \item \emph{mark} a node $u$ of $T$;
%     \item find the \emph{nearest marked ancestor} of a node $u$ of $T$, i.e., the ancestor of $u$ of maximum depth that is marked.
% \end{inparaenum}
% There exists data structures for this problem that use $O(n)$ space and preprocessing and can perform each of these operations in $O(1)$ time  \cite{X}.  Especially simple and efficient solutions exist when the operations are restricted so that the set of marked nodes always induce a connected subtree of $T$.  In this paper we only require this simple version of the data structure.

\section{Tripod Decompositions}

Let $G$ be a $n$-vertex triangulation and $T$ be a spanning tree of $G$. For a face $uvw$ of $G$, a \emph{$(G,T)$-tripod} $Y$ with \emph{crotch} $uvw$ is the vertex set of three disjoint (and each possibly empty) vertical paths (the \emph{legs} of $Y$) whose lower endpoints are $u$, $v$, and $w$.  A \emph{$(G,T)$-tripod decomposition} is a partition of $V(G)$ into $(G,T)$-tripods.  \citet{dujmovic.joret.ea:planar} proved the following result:

\begin{thm}\label{tripod_decomposition}
  Let $G$ be a triangulation and $T$ be a spanning tree of $G$.  Then there exists a $(G,T)$-tripod decomposition $\mathcal{Y}$ such that $G/\mathcal{Y}$ has treewidth at most $3$.
\end{thm}

It is straightforward to verify that \cref{tripod_decomposition} implies \cref{meta}.\ref{three_tree} by first triangulating the given graph and then taking $T$ to be a breadth-first search tree of the resulting triangulated graph \cite[Observation~35]{dujmovic.joret.ea:planar}.

% \begin{remark}
%   The result of \citett{dujmovic.joret.ea:planar} provides tripods with somewhat more structure.  Every tripod has three legs whose lower endpoints are on a common face of $G$.  It is possible to fix, in advance, an $S$-rooted BFS tree $T$ and produce tripods whose legs are paths in $T$.
% \end{remark}

\subsection{Tripod Decompositions from Face Orderings}
\label{orderings}

We now describe how $(G,T)$-tripod decompositions can be obtained from total orders on the faces of $G$.  For any subgraph $f$ of $G$, we define $Y_T(f):=\bigcup_{v\in V(F)} P_T(v)$.  Let $\mathcal{F}:=f_0,\ldots,f_{2n-3}$ be a total ordering of the faces of $G$. Let $G_{-1}$ denote the graph with no vertices and, for each $i\in\{0,\ldots,2n-1\}$, define the graph $G_i:=\bigcup_{j=0}^i (f_j\cup Y_F(f_j))$ and let $Y_i:=V(G_i)\setminus V(G_{i-1})$.
Let $\mathcal{G_F}:=\langle G_0,\ldots,G_{2n-3}\rangle$ and
observe that $\mathcal{Y_F}:=\{Y_0,\ldots,Y_{2n-3}\}$ is a tripod decomposition of $G$.


A sequence $\mathcal{F}:=f_0,\ldots,f_r$ of distinct faces of $G$ is \emph{good} if the resulting sequence of graphs $\mathcal{G}_\mathcal{F}:=G_0,\ldots,G_r$ and tripods $\mathcal{Y}_\mathcal{F}:=Y_0,\ldots,Y_r$ satisfy the following condition:  For each $i\in\{0,\ldots, r\}$ and each face $f$ of $G_i$,
\[
   |\{\ell\in\{0,\ldots,i\}: V(f)\cap Y_{\ell}\neq\emptyset\}|\le 3 \enspace .
\]
In words, each face of each graph $G_i$ has vertices from at most three tripods of $Y_0,\ldots,Y_i$ on its boundary.  \citet{dujmovic.joret.ea:planar} prove \cref{tripod_decomposition} by proving the next lemma.

% In words, this lemma states that if each face of each graph in $\mathcal{G}_{\mathcal{F}}$ has vertices from at most three tripods on its boundary then $G/\mathcal{Y}_\mathcal{F}$ has treewidth at most $3$.

\begin{lem}\label{face_trick}
  Let $G$ be a triangulation $G$ with a vertex $v_0$ on its outer face $f_0$ and let $T$ be a spanning tree of $G$ rooted at $v_0$.  Then there exists a good sequence $\mathcal{F}:=f_0,\ldots,f_{2n-3}$ containing all the faces of $G$.
\end{lem}

\begin{rem}
  \cref{face_trick} is stated in terms of a total order on $F(G)$ only for convenience.  Indeed, consider the partial order $\prec$ defined as follows:  For each $i\in\{1,\ldots,2n-3\}$ let $f_i'$ be the face of $G_{i-1}$ that contains $f_i$; then $f_\ell\prec f_i$ for each $\ell\in\{0,\ldots,i-1\}$ such that $V(f_i')\cap Y_\ell\neq\emptyset$.  It is straightforward to check that any linearization of this total order will result in the same tripod decomposition $\mathcal{Y_F}:=\{Y_0,\ldots,Y_{2n-3}\}$.
\end{rem}

\citet{dujmovic.joret.ea:planar} prove \cref{face_trick} by giving a recursive algorithm that constructs the face sequence $\mathcal{F}$.  For a face $f$ of $G_j$, define the set $I_f:=\{\ell\in\{0,\ldots,j\}:V(f)\cap Y_\ell\neq\emptyset\}$.  They begin with the outer face $f_0$ of $G$.  To find the face $f_i$, $i>0$, they consider some face $f\not\in\{f_0,\ldots,f_{i-1}\}$ of $G_{i-1}$ and use Sperner's Lemma to show that there is an appropriate face $f_i$ (called a \emph{Sperner triangle}) of $G$ that is contained in $f$. In particular, $f_i$ is chosen so that the three vertical paths in $Y_F(f_i)$ lead back to each of the (at most 3) tripods in $\{Y_j:j\in I_f\}$. See \cref{sperner}

\begin{figure}
  \begin{center}
    \begin{tabular}{ccc}
      \includegraphics{figs/sperner-1} &
      \includegraphics{figs/sperner-2} &
      \includegraphics{figs/sperner-3} \\
      (a) & (b) & (c)
    \end{tabular}
  \end{center}
  \caption{Each face $f$ in $G_{i-1}$ is bounded by three tripods $Y_{a_f}$, $Y_{b_f}$, and $Y_{c_f}$ and the tripod $Y_i$ is chosen so that it connects each of these.}
  \label{sperner}
\end{figure}

This immediately leads to a divide-and-conquer algorithm by recursing on each of the at most three new faces in $S_i:=F(G_i)\setminus F(G_{i-1})\setminus \{f_i\}$.  The Sperner triangle $f_i$ can easily be found in time proportional to the number of faces of $G$ in the interior of $f$.  However, because the resulting recursion is not necessarily balanced, a straightforward implementation of this yields an algorithm with $\Theta(n^2)$ worst-case running time.

\citet{morin:fast} later showed that, using an appropriate data structure for $T$, this approach can be implemented in such a way that the resulting algorithm runs in $O(n\log n)$ time.  Essentially, Morin's algorithm works by finding the Sperner triangle $f_i$ in time proportional to the minimum number of faces of $G$ contained in any of the faces in $S_i$.  In the next section, we will show that, by using an appropriate data structure for the cotree $\overline{T}$, the Sperner triangle $f_i$ can be found in constant time, yielding an $O(n)$ time algorithm.

By now, our presentation of this material differs somewhat from that in \cite{dujmovic.joret.ea:planar,ueckerdt.wood.ea:improved}.  Therefore, we now pause to explain how \cref{face_trick} implies \cref{tripod_decomposition}.  To do this, we show that there exists a chordal graph $H$ whose largest clique has size at most $4$ and that contains $G/\mathcal{Y_F}$. For each $i\in\{0,\ldots,2n-3\}$ and each face $f$ of $G_i$, the graph $H$ contains a clique on $\{Y_j:j\in I_f\}$.  To do this, for each $i\in\{1,\ldots,2n-3\}$ we let $f$ be the face of $G_{i-1}$ that contains $f_i$ and we form a clique on $\{Y_i\}\cup\{Y_j:j\in I_f\}$.  Inductively, the elements of $\{Y_j:j\in I_f\}$ already form a clique, so this operation is equivalent to attaching $Y_i$ to all the vertices of an existing clique of size at most $3$. Therefore, this results in a chordal graph $H$ whose largest clique has size at most $4$ and therefore $H$ has treewidth at most $3$ \cite{gavril:intersection}.

\section{An $O(n)$-Time Algorithm}
\label{linear_time_algorithm}

Refer to \cref{baby_sperner_fig} for an illustration of the following (probably well-known) baby version of Sperner's Lemma:

\begin{figure}
  \begin{center}
    \includegraphics{figs/baby_sperner}
  \end{center}
  \caption{\cref{baby_sperner}}
  \label{baby_sperner_fig}
\end{figure}

\begin{lem}\label{baby_sperner}
  Let $N$ be a near-triangulation with outer face $v_0,\ldots,v_r$ and colour each vertex of $N$ red or blue in such a way that $v_0,\ldots,v_i$ are coloured red for some $i\in\{0,\ldots,r-1\}$ and $v_{i+1},\ldots,v_r$ are coloured blue.  Then there exists a path $w_0,\ldots,w_k$ in $N^\star$ such that
  \begin{compactenum}
    \item $w_0$ is the inner face of $N$ with $v_0v_r$ on its boundary;
    \item $w_k$ is the inner face of $N$ with $v_iv_{i+1}$ on its boundary; and
    \item for each $i\in\{1,\ldots,r\}$, the single edge in $E(w_{i-1})\cap E(w_i)$ has an endpoint of each colour.
  \end{compactenum}
\end{lem}

\begin{proof}
  If $w_0=w_k$, the lemma is immediately true, so assume $w_0\neq w_k$.
  Say that an edge of $n$ is \emph{bichromatic} if one of its endpoints is red and the other is blue.  Any edge that is not bichromatic is \emph{monochromatic}.  The outer face $f_0$ of $N$ has exactly two bichromatic edges $v_0v_r$ and $v_iv_{i+1}$ and any inner face of $N$ has either zero or two bichromatic edges.  Consider the subgraph $H$ of $N^\star$ obtained removing each edge $fg\in E(N^\star)$ such that the edge in $E(f)\cap E(g)$ is monochromatic.  Every vertex in $H$ has degree $0$ or $2$, so each connected component of $H$ is either an isolated vertex of a cycle.  The face $f_0$ has degree $2$ so it is contained in a cycle $C$ of $H$.  The two neighbours of $f_0$ in $H$ are $w_0$ and $w_k$. Therefore $C$ contains a path $w_0,\ldots,w_k$ that satisfies the conditions of the lemma.
\end{proof}

The next lemma, which is the main observation in this paper, allows us to use lowest common ancestor data structures to find Sperner triangles in constant time.

\begin{lem}\label{lca_sperner}
  Let $G$ be a triangulation $G$ with a vertex $v_0$ on its outer face $f_0$; let $T$ be a spanning tree of $G$ rooted at $v_0$; let $\overline{T}$ be the cotree of $(G,T)$ rooted at $f_0$; let $f_0,\ldots,f_{i-1}$ be a good sequence of faces of $G$ that yields a sequence $\mathcal{G_F}:=G_0,\ldots,G_{i-1}$ of graphs and a sequence $\mathcal{Y_F}:=Y_0,\ldots,Y_{i-1}$ of tripods; let $f\not\in \{f_0,\ldots,f_{i-1}\}$ be a face of $G_{i-1}$ with $|I_f:=\{j\in\{0,\ldots,i-1\}:V(I_f)\cap Y_j\neq\emptyset\}|=3$, and let $L\subseteq F(G)$ contain every face $g\in F(G)$ such that
  \begin{compactenum}[(i)]
      \item $g$ is contained in the interior of $f$;
      \item $g$ contains an edge $vw\in E(f)$ with $v\in Y_a$ and $w\in Y_b$ for some distinct $a,b\in\{0,\ldots,i-1\}$.
  \end{compactenum}
  Then there exists a face $f_i$ of $G$ that is contained in $f$ and such that
  \begin{compactenum}[(a)]
    \item $f_0,\ldots,f_i$ is good; and
    \item $f_i :=\lca_{\overline{T}}(x,y)$ for some $x,y\in L$.
  \end{compactenum}
\end{lem}

\begin{proof}
  Let $N$ be the near-triangulation consisting of all vertices and edges of $G$ in the closure of the interior of $f$ and let $\{a,b,c\}:=I_f$.  Colour each vertex $v$ of $N$ with a colour in $\{a,b,c\}$ depending on whether the first vertex of $P_{T}(v)$ contained in $V(f)$ belongs to $Y_a$, $Y_b$, or $Y_c$, respectively.  Say that an edge or face of $N$ is \emph{monochromatic}, \emph{bichromatic}, or \emph{trichromatic} if it contains vertices of one, two, or three colours, respectively.  It is straightforward to verify that any trichromatic inner face $f_i$ of $N$ will satisfy Condition~(a). By Sperner's Lemma, such a trichromatic face $f_i$ does indeed exist. All that is needed is to check that $f_i$ satisfies Condition~(b).  There are two cases to consider:
  \begin{enumerate}
    \item $f_i$ contains an edge $uv\in E(f)$.  Since $f_i$ is trichromatic,  $u$ and $v$ have different colours, so $f_i\in L$.  Furthermore, $f_i=\lca_{\overline{T}}(f_i,f_i)$, so $f_i$ satisfies Condition~(b).

    \item $f_i$ contains no edge of $f$.  See \cref{lca_proof}.  The graph $G_i$ contains exactly four faces $g_1',g_2',g_3',f_i$ that are not faces of $G_{i-1}$, but that are contained in $f$. For each $j\in\{1,2,3\}$, the face $g_j'$ contains exactly one face $g_i$ of $G$ such that $E(g_j)\cap E(f)$ contains a bichromatic edge in $E(f)$.

    \begin{figure}
      \begin{center}
        \begin{tabular}{cc}
          \includegraphics{figs/lca_proof-1} &
          \includegraphics{figs/lca_proof-2} \\
          $G_i$ & $G$
        \end{tabular}
      \end{center}
      \caption{The cotree $\overline{T}$ contains disjoint paths from $f_i$ to each of $g_1$, $g_2$, and $g_3$.}
      \label{lca_proof}
    \end{figure}

    We claim that, for each $j\in\{1,2,3\}$, $\overline{T}$ contains a path from $f_i$ to $g_j$ and, with the exception of $f_i$, these paths are disjoint.  In order to show this, we first argue that no bichromatic edge in the interior of $f$ is an edge of $T$.  Consider any $uv\in E(N)\setminus E(f)$ where $u$ is the $T$-parent of $v$.  If $v\not\in V(f)$ then, by definition, $v$ has the same colour as $u$. The case where $v\in V(f)$ and $u\not\in V(f)$ can not occur since $v\in V(f)$ implies that $P_T(v)\subseteq G_{i-1}$, but $u\not\in V(G_{i-1})$.  Similarly, the case in which $u\in V(f)$ and $v\in V(f)$ can not occur since this implies that $P_T(v)\subseteq G_{i-1}$, but $uv\not\in E(G_{i-1})$.

    Now, for each $j\in\{1,2,3\}$, let $N_j$ be the near-triangulation consisting of the faces and edges of $G$ in the interior and on the boundary of $g_j'$.  Then the colouring of $N$, restricted to $N_j$ satisfies the conditions of \cref{baby_sperner} so $N^\star$ contains a path $w_{-1},w_0,\ldots,w_{k}$ with $w_{-1}=f_i$, $w_{k}=g_j$, and $w_0,\ldots,w_{k-1}$ contained in $g_j'$ and such that, for each $\ell\in\{0,\ldots,k\}$, the edge shared by $w_{\ell-1}$ and $w_\ell$ is bichromatic.  Therefore $w_{-1},w_0\ldots,w_k$ is a path in $\overline{T}$ from $f_i$ to $g_j$.

    Each of the three paths from $f_i$ to each of $g_1,g_2,g_3$ are disjoint except for their shared starting point $f_i$.  Therefore, since $f_i$ has only one $\overline{T}$-parent, at least two of $g_1,g_2,g_3$ are $\overline{T}$-descendants of $f_i$, say $g_1$ and $g_2$.  Therefore $f_i:=\lca_{\overline{T}}(g_1,g_2)$, as required. \qedhere
  \end{enumerate}
\end{proof}

\cref{lca_sperner} implies that, given the triangles $q_1$, $q_2$ and $q_3$, one can use a lowest common ancestor data structure to find, in constant time a constant-size set $S:=\{\lca_{\overline{T}}(g_\alpha,g_\beta):\alpha,\beta\in\{1,2,3\}\}$ of candidate faces, one of which is the Sperner triangle $f_i$.
This quickly leads to an $O(n)$ time algorithm that, like the algorithm of \citet{morin:fast} uses a nearest marked ancestor data structure on $T$ to recognize which of these candidate faces is the correct choice for $f_i$.

We now show that the nearest marked ancestor data structure can be eliminated entirely. Instead, we can identify the face $f_i\in S$ using only lowest common ancestor queries.  Using the notation from \cref{lca_sperner}, let $C$ be the outer face of $N$ and let $g_1$, $g_2$, and $g_3$ be the inner faces of $N$ having bichromatic edges of $C$ on their boundary where $g_1$ has an edge of $C$ coloured with $a$ and $b$, $g_2$ has an edge of $C$ coloured with $b$ and $c$, and $g_3$ has an edge of $C$ coloured with $a$ and $c$.  There are three cases, illustrated in \cref{lca_cases}.

\begin{figure}
  \begin{center}
    \begin{tabular}{ccc}
      \includegraphics{figs/lca_cases-1} &
      \includegraphics{figs/lca_cases-2} &
      \includegraphics{figs/lca_cases-3} \\
      (1) & (2) & (3)
    \end{tabular}
  \end{center}
  \caption{Identifying a Sperner triangle $f_i$ using lowest common ancestor queries over $g_1$, $g_2$, and $g_3$.}
  \label{lca_cases}
\end{figure}

\begin{enumerate}
  \item If $g_\alpha=g_\beta$ for some distinct $\alpha,\beta\in\{1,2,3\}$  then $g_\alpha$ is trichromatic and we can take $f_i:=g_\alpha$.  In the proof of \cref{lca_sperner}, this corresponds to the case where $f_i$ has an edge of $C$ on its boundary.

  % \item If $\lca_{\mathcal{T}}(g_\alpha,g_\beta)=g_\gamma$ for distinct $\alpha,\beta,\gamma$ then $g_\beta$ is trichromatic and we are done.

  \item If $\lca_{\mathcal{T}}(g_\alpha,g_\beta)=g_\beta$ and $\lca_{\overline{T}}(g_\beta,g_\gamma)=q$ for distinct  $\alpha$, $\beta$, $\gamma$, and $q\ne g_\beta$ then $g_\beta$ is trichromatic and we are done.  Note that this includes the case where $g_\gamma=q$ or $g_\beta=q$.  In the proof of \cref{lca_sperner} this also corresponds to the case where $f_i$ has an edge of $C$ on its boundary.

  \item If $\lca_{T}(g_\alpha,g_\beta)=p$, $\lca_{T}(g_\beta,g_\gamma)=q$,  $\lca_{\overline{T}}(g_\alpha,g_\gamma)=q$, and $\lca_{\overline{T}}(p,q)=q$ for distinct $\alpha$, $\beta$, $\gamma$, $p$, and $q$, then $p$ is trichromatic and we are done. This includes the possibility that  $q=g_\gamma$.  In the proof of \cref{lca_sperner} this corresponds to the case where $f_i$ has no edge of $C$ on its boundary.
\end{enumerate}
The preceding cases are exhaustive since, after ruling out Case~1, the minimal subtree of $\overline{T}$ that contains $g_1$, $g_2$, and $g_3$ is a binary tree whose leaves are a subset of $\{g_1,g_2,g_3\}$.  Any binary tree with $n\ge 3$ nodes and at most $3$ leaves has either $2$ leaves (Case~2) or $3$ leaves (Case 3).

\begin{rem}\label{colour_remark}
  The process described above not only makes it possible to identify $f_i$ in constant time, but also makes it possible to determine the colours of each of the three vertices of $f_i$ in constant time.  This is clearly true for Cases~1 and 2. To handle Case~3, we can use three queries in the lowest common ancestor data structure for $\overline{T}$ to determine the first edge on the path in $\overline{T}$ from $f_i$ to each of $g_1,g_2,g_3$.  For each $j\in\{1,2,3\}$, the colours on $g_j$ are the same as those of the edge of $f_i$ that is dual to the first edge on the path to $g_j$.
\end{rem}



\begin{thm}
  There exists an $O(n)$ time algorithm that, given any $n$-vertex triangulation $G$ and any spanning tree $T$ of $G$, produces a $(G,T)$-tripod decomposition $\mathcal{Y}$ such that $\tw(G/\mathcal{T})\le 3$.
\end{thm}

\begin{proof}
  Let $f_0$ be any face of $G$ incident to $v_0$.  First we compute the cotree $\overline{T}$ of $(G,T)$ and construct  a lowest common ancestor data structure for $\overline{T}$ in $O(n)$ time that allows us to compute $\lca_{\overline{T}}(f,g)$ for any two faces $f,g\in F(G)$ in $O(1)$ time.

  We construct the good sequence $f_0,\ldots,f_{2n-3}$ recursively. Conceptually, during any recursive invocation, the input is a near-triangulation $N$ bounded by a cycle $C$ in $G$ whose vertices belong to at most three tripods computed in previous steps.  Each vertex of $G$ starts initially \emph{unmarked} and we \emph{mark} a vertex once we have placed it in a tripod.  The precise input to a recursive invocation is defined as follows:
  \begin{enumerate}
    \item If $C$ has three tripods of on its boundary then the input consists of the three inner faces $g_1$, $g_2$, and $g_3$ of $N$ that contain bichromatic edges of $C$. In this case, the discussion above allows us to find the Sperner triangle $f_i$ in $O(1)$ time using a constant number of queries in the lowest common ancestor data structure for $\overline{T}$.

    \item If $C$ has only two tripods on its boundary, then the input consists of two inner faces $g_1$, $g_2$, of $N$ with bichromatic edges of $C$ on their boundary.  In this case, we let $f_i:=g_1$ or $f_i=g_2$, either choice satisfies our requirements.

    \item If $C$ has only one tripod on its boundary then the input consists of any inner face of $N$ with that contains an edge of $C$.
\end{enumerate}
Once we have found the Sperner triangle $f_i$, we can compute the tripod $Y_i$ by following the path in $T$ from each vertex of $f_i$ to its nearest marked ancestor in $T$.  This takes $O(1+|Y_i|)$ time.  Once we have done this, we have also found the at most three bichromatic edges of $G_i$ that are needed to perform the at most three recursive invocations on the near triangulations whose outer faces are each of the new faces in $F(G_i)\setminus F(G_{i-1})\setminus\{f_i\}$.

Each recursive invocation adds a new face $f_i$ to the good face sequence $f_0,\ldots,f_{2n-3}$ and takes $O(1+|Y_i|)$ time.  Since $Y_0,\ldots,Y_{2n-3}$ is a partition of $V(G)$, the running time of this algorithm is therefore $\sum_{i=0}^{2n-3} O(1+|Y_i|) = O(n)$.
\end{proof}


\section{Variations}

In this section we show that there are $O(n)$ time algorithms for computing the decompositions in \cref{meta}.b and \cref{meta}.c.  Both algorithms are based on the fact that lowest common ancestor information is sufficient to reconstruct the shapes of certain subtrees of the cotree $\overline{T}$.

\begin{lem}\label{reconstruction}
  Let $\overline{T}$ be a rooted tree of maximum degree $3$, let $S:=g_1,\ldots,g_d$ be a sequence of distinct nodes in $\overline{T}$ and let $S^+:=\{\lca_{\overline{T}}(x,y):x,y\in S\}$.  Then there exist a unique rooted tree $\overline{T}'$ of maximum degree $3$ with $V(\overline{T}'):= S^+$ and $\lca_{\overline{T'}}(x,y)=\lca_{\overline{T}}(x,y)$ for each $x,y\in S$.
\end{lem}

\begin{proof}
  TODO
   % The proof is by induction on $|S|$.  The base case $|S|=1$ and $T'$ consists of a single vertex.  The case $|S|=2$ is also straightforward. If $S:=\{u,v\}$ then either $\lca_{\overline{T}(u,v)\in\{u,v\}$ or  $\lca_{\overline{T}(u,v)\in\{u,v\}$. In the former case $\overline{T}'$ consists of a single edge $uv$ and in the latter case, $\overline{T}'$ is a $3$-vertex tree with leaves $u$ and $v$ and root $\lca_{\overline{T}}(u,v)$.
   %
   % Now, suppose that $|S|\ge 3$.  Then there exist a pair of distinct element $x,y\in S$ such that $\lca_\overline{T}(x,y)
\end{proof}

% the following two variations on the product structure theorem also have linear-time algorithms:
% \begin{itemize}
%   \item For every planar graph $G$, there exists a planar graph $H$ of  treewidth at most $6$ and a path $P$ such that $G\subseteq H\boxtimes P$ \cite{ueckerdt.wood.ea:improved}.
%   \item For every planar graph $G$, there exists a planar graph $H$ of treewidth at most $4$ and a path $P$ such that $G\subseteq H\boxtimes P\boxtimes K_2$.
% \end{itemize}
%
% Both of these results are obtained by recursive algorithm similar to that described for computing tripod decompositions.

\subsection{Bipod Decompositions}

We begin with the decomposition in \cref{meta}.\ref{bipods}, which is simpler, but seems not to have been noted before.  This decomposition is obtained by selecting a sequence $\mathcal{E}:=e_1,\ldots,e_k$ of distinct edges of $G$, which define a sequence of graphs $\mathcal{G_E}:=G_{0},\ldots,G_k$ where $G_i:=\bigcup_{j=0}^i P_T(e_j)$ and a sequence of \emph{bipods} $\mathcal{I_E}:=\Lambda_0,\ldots,\Lambda_k$ where $\Lambda_i=V(G_i-G_{i-1})$.  We call $\mathcal{E}$ \emph{good} if, for each $i\in\{0,\ldots,k\}$ and each face $f\in F(G_i)$, $V(f)$ has a non-empty intersection with at most $4$ bipods in $\Lambda_0,\ldots,\Lambda_i$.

Exactly the same argument used in \cref{orderings} to show that $G/\mathcal{Y_F}$ is contained in a chordal graph of maximum clique size $4$ shows that if $\mathcal{E}$ is a good edge sequence that produces a partition $\mathcal{I_E}$ of $V(G)$, then $G/\mathcal{I_E}$ is contained in a chordal graph of maximum clique size $5$, so $G/\mathcal{I_E}$ has treewidth at most $4$.

\begin{figure}
  \begin{center}
    % \begin{tabular}{cc}
      \includegraphics{figs/fourby}
      % \includegraphics{figs/bipods-2}
    % \end{tabular}
  \end{center}
  \caption{Choosing the next $e_i$ in a  good edge sequence.}
  \label{e_i}
\end{figure}

We now explain why such an edge sequence $e_0,\ldots,e_r$ exists.  The edge $e_0$ is any edge of $E(f_0)\setminus E(T)$.  To choose the edge $e_i$, $i>0$, we consider any face $f\in F(G_{i-1})\setminus F(G)$.  The face $f$ has vertices of at most four bipods $\Lambda_a$, $\Lambda_b$, $\Lambda_c$, and $\Lambda_{d}$ on its boundary.  As before we colour vertices in the near triangulation $N$ bounded by $f$ with colours $a$, $b$, $c$, and $d$. Now we consider the subgraph $X$ of $N^\star$ induced by the bichromatic and trichromatic inner faces of $N$.  As in \cref{linear_time_algorithm}, $X$ is also a connected subgraph of $\overline{T}$.

There are a number of cases to consider, which are all easily handled.  In the extreme case, illustrated in \cref{e_i}, the graph $X$ has four leaves $g_1,\ldots,g_4$ and two internal nodes $x$ and $y$.  Any edge of $N$ that is dual to an edge on the path in $X$ from $x$ to $y$ will work to determine a bipod $e_i$ that satisfies our requirements.  In the general case, it is sufficient to find an edge of the tree $X$ whose removal leaves no component with more than two of $g_1,\ldots,g_4$.

Algorithmically, using \cref{reconstruction}, we can determine the ``shape'' of the tree $X$ by performing lowest common ancestor queries on the at most four inner faces of $N$ that contain bichromatic edges of the outer face of $N$.  The details and analysis of the rest of the algorithm are the same as in \cref{linear_time_algorithm}.



%
%
%
% ; using colour $c$ for vertices that lead to $c$ or to $c'$.  Again, Sperner's Lemma implies that that $N$ contains an inner face $f_i$ that is trichromatic.  In the graph $G_i^+:=G_{i-1}\cup P_T(f_i)$, each newly introduced face in $F(G_{i}^+)\setminus F(G_{i-1})\setminus\{f_i\}$ is incident on at most two of $\Lambda_a$, $\Lambda_b$ or $\Lambda_{c}\cup \Lambda_{c'}$.  Two of these faces are incident at most two of $\Lambda_a$, $\Lambda_b$, $\Lambda_c$ or $\Lambda_c'$.  These two faces are separated by one of the legs of $f_i$ whose lower endpoint is a vertex $v_i\in V(f_i)$.  We take $e_i$ to be the unique edge in $f_i-v_i$.  We can easily check that this results in a good sequence $e_0,\ldots,e_i$ of edges.  This process terminates when $G_k=G$.  That is, each edge of $G$ is contained in $P_T(e_i)$ for some $i\in\{0,\ldots,k\}$.
%
% Algorithmically, this process requires almost no changes from the process used to find good face sequences.  Each recursive subproblem is defined by the at most $4$ inner faces of a near-triangulation that contain a edge of the outer face that spans two bipods.  The triangle $f_i$ is identified by using lowest common ancestor queries on three of these faces.  Using \cref{colour_remark}, the vertex $v_i$ of $f_i$ that is not part of $e_i$ can also be identified in constant time.  Colouring the vertices of $\Lambda_i$ and finding the at most four new faces of $G$ required to define the at most two new recursive subproblems can be done in $O(1+|\Lambda_i|)$ time.  This establishes the following result:

\begin{thm}
  There exists an $O(n)$ time algorithm that, given any $n$-vertex triangulation $G$ and any spanning tree $T$ of $G$, produces a $(G,T)$-bipod decomposition $\mathcal{I}$ such that $\tw(G/\mathcal{I})\le 4$.
\end{thm}


\subsection{Monopod Decompositions}

Finally the decomposition given by \citet{ueckerdt.wood.ea:improved} works similarly, but each part in the decomposition is a \emph{monopod}: a single vertical path in $T$. Each recursive subproblem is a near triangulation $N$ whose outer face contains vertices of at most $5$ monopods of the partition. This gives up to five inner faces $g_1,\ldots,g_5$ of $N$ that each contain an edge of the outer face of $N$ whose endpoints are in different monopods.

Refer to \cref{uwy}.  The key observation used in \cite{ueckerdt.wood.ea:improved} is that there exists a tripod $Y_i$ with crotch $f_i$ such that each inner face of $N\cup Y_i$ has vertices of at most three of the original five monopods on its boundary.  The three legs of $Y_i$ are placed into individual monopods of the decomposition.  This then gives three new subproblems, each of which has vertices of at most three of the original monopods and two of the new monopods on its boundary.

\begin{figure}
  \begin{center}
    \includegraphics{figs/fiveby}
  \end{center}
  \caption{The selection of a tripod by \citet{ueckerdt.wood.ea:improved}}
  \label{uwy}
\end{figure}

In terms of the cotree $\overline{T}$, the minimal subtree $X \subseteq\overline{T}$ that contains $g_1,\ldots,g_5$ has up to three nodes of degree $3$.  These three nodes (and the shape of the tree $X$) can be determined using $O(1)$ lowest common ancestor queries in $\overline{T}$.  The correct choice for the node $f_i$ corresponds to a node of $\overline{T}'$ whose removal disconnects $X$ into components, none of which contains more than $2$ of $g_1,\ldots,g_5$.  We leave the details to the interested reader.

\begin{thm}
  There exists an $O(n)$ time algorithm that, given any $n$-vertex triangulation $G$ and any spanning tree $T$ of $G$, produces a $(G,T)$-monopod decomposition $\mathcal{I}$ such that $\tw(G/\mathcal{I})\le 6$.
\end{thm}


\section*{Acknowledgement}

This research was initiated at the BIRS 21w5235 Workshop BIRS on Graph Product Structure Theory, held November 21--26, 2021 at the Banff International Research Station.  The authors are grateful to the workshop organizers and participants for providing a stimulating research environment.


\bibliographystyle{plainurlnat}
\bibliography{ps2}


\end{document}
