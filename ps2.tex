\documentclass{patmorin}
\listfiles
\usepackage{pat}
\usepackage{paralist}
\usepackage{dsfont}  % for \mathds{A}
\usepackage[utf8x]{inputenc}
\usepackage{skull}
\usepackage{paralist}
\usepackage{graphicx}
\usepackage[noend]{algorithmic}

\usepackage[normalem]{ulem}
\usepackage{cancel}
\usepackage{enumitem}

\usepackage{todonotes}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

\newcommand{\Rho}{\mathrm{P}}

\usepackage[mathlines]{lineno}
\setlength{\linenumbersep}{2em}
% \linenumbers
% \rightlinenumbers
% \linenumbers
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
 \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
 \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
 \renewenvironment{#1}%
    {\linenomath\csname old#1\endcsname}%
    {\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
 \patchAmsMathEnvironmentForLineno{#1}%
 \patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
\patchBothAmsMathEnvironmentsForLineno{equation}%
\patchBothAmsMathEnvironmentsForLineno{align}%
\patchBothAmsMathEnvironmentsForLineno{flalign}%
\patchBothAmsMathEnvironmentsForLineno{alignat}%
\patchBothAmsMathEnvironmentsForLineno{gather}%
\patchBothAmsMathEnvironmentsForLineno{multline}%
}


\newcommand{\coloured}[2]{{\color{#1}{#2}}}
\newenvironment{colourblock}[1]{\color{#1}}{}

\newcommand{\condref}[1]{(C\ref{#1})}

% Taken from
% https://tex.stackexchange.com/questions/42726/align-but-show-one-equation-number-at-the-end
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}


\setlength{\parskip}{1ex}


\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\stw}{stw}
\DeclareMathOperator{\ltw}{ltw}
\DeclareMathOperator{\pw}{pw}
\DeclareMathOperator{\lpw}{lpw}
\DeclareMathOperator{\lhptw}{lhp-tw}
\DeclareMathOperator{\lhppw}{lhp-pw}

\DeclareMathOperator{\x}{x}
\DeclareMathOperator{\height}{height}
\DeclareMathOperator{\depth}{depth}
\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\sh}{cbt}
\DeclareMathOperator{\cbt}{cbt}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\dc}{dc}

\title{\MakeUppercase{An Optimal Algorithm for Product Structure in Planar Graphs}\thanks{This research was partly funded by NSERC.}}
\author{%
  Prosenjit Bose,\thanks{School of Computer Science, Carleton University}\qquad
  Vida Dujmović,\thanks{Department of Computer Science and Electrical Engineering, University of Ottawa}\qquad
  Pat Morin,\footnotemark[1]\qquad
  Saeed Odak\footnotemark[2]}
    % }

\date{}


\newcommand{\colored}[2]{{\color{#1}#2}}

\usepackage{tabularx}


\begin{document}

% \begin{titlepage}
\maketitle

\begin{abstract}
    The Product Structure Theorem for planar graphs (Dujmović et al, 2019) states that any planar graph is contained in strong product of a planar $3$-tree, a path, and $3$-cycle.  We give an alternative proof of this theorem that leads to a linear-time algorithm.
\end{abstract}
% \end{titlepage}

% \pagenumbering{roman}
% \tableofcontents
%
% \newpage
% \pagenumbering{arabic}

\section{Introduction}

\section{Preliminaries}

Throughout this paper we use standard graph theory terminology as used in the textbook by Diestel \cite{diestel:graph}.  All graphs discussed here are finite.  A \emph{triangulation} is an edge-maximal planar graph.  We will assume that any triangulation is embedded without crossings in $\R^2$ so that any cycle in a triangulation defines a Jordan curve. For such a cycle $C$, $\R^2\setminus C$ has two components, one bounded and unbounded. We will refer to the bounded component as the \emph{interior} of $C$ and the unbounded component as the \emph{exterior} of $C$.  The \emph{outer face} of a triangulation $G$ is the unique $3$-cycle in $G$ with no vertices of $G$ in its interior.

A \emph{cutset} in a graph $G$ is a subset $S$ of $V(G)$ such that $G-S$ has more than one connected component.  A \emph{separating triangle} in a triangulation $G$ is a $3$-cycle $uvw$ in $G$ whose vertices form a cutset.  It is well known that any $3$-vertex cutset $\{u,v,w\}$ in a triangulation is a separating triangle and that $G-\{u,v,w\}$ has exactly two components, one contained in the interior of $uvw$ and one contained in the exterior of $uvw$.

% See Diestel \cite[Chapter 12]{diestel:graph} for definitions of treewidth and tree decompositions.

For any graph $G$ and any set $S$, the \emph{induced subgraph} $G[S]$ is the graph with vertex set $V(G[S]):=V(G)\cap S$ and edge set $E(G[S]):=\{vw\in E(G):v,w\in S\}$.  When $G$ is triangulation and $f$ is a face of $G$, we will sometimes treat $f$ as a subgraph of $G$ that includes all vertices and edges of $G$ on the boundary of $f$.

Let $G$ be a graph. A \emph{path} in $G$ is a (possibly empty) sequence of vertices $v_0,\ldots,v_r$ with the property that $v_{i-1}v_i\in E(G)$, for each $i\in\{1,\ldots,r\}$.  The \emph{endpoints} of a path $v_0,\ldots,v_r$ are the vertices $v_0$ and $v_r$.  We will treat a path $v_0,\ldots,v_r$ interchangeably with the subgraph of $G$ having vertex set $\{v_0,\ldots,v_r\}$ and edge set $\{v_{i-1}v_i:i\in\{1,\ldots,r\}\}$.  The \emph{length} of a non-empty path $v_0,\ldots,v_r$ is the number, $r$, of edges in the path.  The \emph{length} of an empty path is $-1$. For two vertices $v,w\in V(G)$, $\dist_G(v,w)$ denotes the length of a shortest path in $G$ that contains $v$ and $w$, or $\dist_G(v,w):=\infty$ if $v$ and $w$ are in different connected components of $G$.  For a non-empty subset $S\subseteq V(G)$, $\dist_G(v,S):=\min\{\dist_G(v,w):w\in S\}$.

% For a tree $T$ rooted a vertex $v_0\in V(T)$, the \emph{depth} of a node $v\in V(T)$ is $\depth_T(v):=\dist_T(v,v_0)$.  A forest, $F$ rooted at a set $S$ is the union of vertex-disjoint trees $(T_x:x\in S)$ such that $T_x$ is a tree rooted at $x$, for each $x\in S$.  The \emph{depth} of a node $v$ in a forest rooted at $S$ is $\depth_F(v):=\dist_F(v,S)$.  The \emph{height} of a forest $F$ is $\height(F):=\max\{\depth_F(v):v\in V(F)\}$.  A \emph{vertical path} in a forest $F$ is a path $v_0,\ldots,v_r$ in $F$ with $\depth_F(v_i)=\depth_F(v_{i-1})-1$ for each $i\in\{1,\ldots,r\}$.  The \emph{lower endpoint} of a vertical path $v_0,\ldots,v_r$ is $v_0$ and $v_r$ is the \emph{upper endpoint}.  A \emph{breadth-first-search (BFS) forest} $F$ rooted at $S$ is a spanning forest of $G$ rooted at $S$ with the property that $\dist_G(v,S)=\depth_F(v)$ for each $v\in V(G)$.

A \emph{layering} $\mathcal{L}:=\langle L_i\rangle_{i\in\N}$ of a graph $G$ is a partition of $V(G)$ into sets such that $L_0$ is non-empty and, for each edge $uv$ of $G$, if $u\in L_i$ and $v\in L_j$, then $|i-j|\le 1$.  The maximum $i\in\N$ such that $L_i$ is non-empty is the \emph{height} of $\mathcal{L}$.
For any $v\in V(G)$, $\depth_\mathcal{L}(v)$ is the unique index $d$ such that $v\in L_d$. For a set $S\subseteq V(G)$, the \emph{$S$-rooted BFS layering} of $G$ is the layering obtained by setting $L_i:=\{v\in V(G):\dist_G(v,S)=i\}$ for each $i\in\N$.


\begin{lem}\label{good_edge}
  Let $G$ be a planar graph with $n\ge 2$ vertices, let $r$ be a vertex of $G$, let $\mathcal{L}:=\langle L_i\rangle_{i\in\N}$ be a $\{r\}$-rooted BFS layering of $G$ and let $h$ be the height of $\mathcal{L}$.
  Then $G$ contains an edge $uv$ with $u\in L_{h-1}$ and $v\in L_{h}$ such that
  \begin{compactenum}[(a)]
    \item $|N_G(v)\cap L_h|\le 2$ and $|N_G(v)\cap L_{h-1}|\le 2$ , or\label{low_degree}
    \item $|N_G(u)\cap L_h|=1$.\label{only_child}
  \end{compactenum}
\end{lem}

\begin{proof}
  It is well known that the subgraph induced by any single BFS layer of a planar graph is an outerplanar graph.  Therefore $G[L_h]$ is outerplanar.  It is also well known that any non-empty outerplanar graph has a vertex of degree at most $2$ and that any outerplanar graph with at least two vertices has at least two vertices of degree at most $2$.  Since $L_h$ is non-empty, there exists $v\in L_h$ with  $\deg_{G[L_h]}(v)\le 2$.  Since $n\ge 4$, $h\ge 1$.  Therefore, the vertex $v$ has at least one neighbour $u$ in $L_{h-1}$.  If $v$ has at most two neighbours in $L_{h-1}$, then $\deg_G(v)=\deg_{G[L_h]}(v)+|N_G(v)\cap L_{h-1}|\le 2+2=4$ and the edge $uv$ satisfies (\ref{low_degree}) and we are done.

  Suppose therefore that $v$ has at least three neighbours in $L_{h-1}$. We recall a result of \citet{pupyrev:mixed} on \emph{ordered concentric representations} which states that $G$ has a planar embedding with $S$ on the outer face and, for each $i\in\{0,\ldots,h\}$,
  \begin{compactenum}
    \item the vertices of $L_i$ are embedded on the circle $C_i$ of radius $i+1$ centred at the origin;
    \item each edge $xy$ of $G$ with $x,y\in L_i$ is embedded as a curve whose interior is outside of the circle $C_i$;
    \item each edge $xy$ of $G$ with $x\in L_i$ and $y\in L_{i+1}$ is embedded as  a curve whose interior is the union of
    \begin{inparaenum}[(i)]
      \item a curve that is outside of $C_i$ but inside of $C_{i+1}$,
      \item a point on $C_{i+1}$, and
      \item a curve that is outside of $C_{i+1}$.
    \end{inparaenum}
  \end{compactenum}
  Identify each vertex of $G$ with the point that represents it in such an ordered concentric representation and each edge of $G$ with the curve that represents it.  Refer to \cref{gammas}.  If $v$ has at least three neighbours in $L_{h-1}$ then there exists an arc $\Gamma_0$ of $C_{h-1}$ with endpoints $u_0$ and $u_2$ that contains exactly three neighbours $u_0$, $u$, and $u_2$ of $v$.  Let $\Gamma_1$ be the minimal arc of $C_h$ that contains $v$ and the intersections of the edges $u_0v$ and $u_2v$ with $C_h$.  Observe that $N_G(u)\cap L_h\subseteq \Gamma_1\cap L_h$.  Therefore, if $\Gamma_1\cap L_h=\{v\}$, then the edge $uv$ satisfies (\ref{only_child}) and we are done.
  \begin{figure}
    \begin{center}
      \begin{tabular}{c@{\hspace{1cm}}c}
        \includegraphics{figs/gammas-1} & \includegraphics{figs/gammas-2}
      \end{tabular}
    \end{center}
    \caption{A step in the proof of \cref{good_edge}.}
    \label{gammas}
  \end{figure}

  Suppose therefore that $|\Gamma_1\cap L_h|\ge 2$.  Partition $\Gamma_1$ into two subarcs $\Gamma_{1,a}$ and $\Gamma_{1,b}$ each having an endpoint at $uv\cap C_h$, with $\Gamma_{1,a}$ having an endpoint at $u_0v\cap C_h$ and $\Gamma_{1,b}$ having an endpoint on $u_2v\cap C_h$.   Define $\Gamma_{0,a}$ and $\Gamma_{0,b}$ similarly as the two arcs obtained by cutting $\Gamma_0$ at $u$.  Without loss of generality, we may assume that $Q:=\Gamma_{1,a}\cap L_h\setminus\{v\}$ is non-empty.  Then $G[Q\cup\{v\}]$ is an outerplanar graph with at least two vertices, so it contains at least two vertices of degree at most $2$.  Let $v'$ be a vertex in $Q$ such that $\deg_{G[Q\cup\{v\}}(v')\le 2$.  Observe that $\deg_{G[L_h]}(v')=\deg_{G[Q\cup\{v\}]}(v')\le 2$.  Therefore, we may repeat the entire argument, from the beginning, using $v'$ in place of $v$.  This will either show that some edge $u'v'$ incident on $v'$ satisifies the conditions of the lemma, or will lead to the same situation with arcs $\Gamma_0'$ and $\Gamma_1'$ defined analagously to $\Gamma_0$ and $\Gamma_1$.  The key observation is that $\Gamma_0'\subseteq\Gamma_{0,a}$ and therefore $|\Gamma_0'\cap L_{h-1}| < |\Gamma_0\cap L_{h-1}|$ since $\Gamma_0'$ does not contain $u_2$.  This cannot continue indefinitely so it will eventually lead to an edge $u''v''$ satisfying the conditions of the lemma.
\end{proof}


In the following, we work with edge contractions, which we treat as a directed operation.  Contraction of an edge $uv$ in $G$ produces a new graph $G'$ obtained by removing $v$ from $G$ and adding the edge $uw$ for each $w\in N_G(v)\setminus N_G(u)\setminus\{u\}$.  Observe that, if $G'$ is a triangulation with $n\ge 4$ vertices and $uv$ is not part of a separating triangle of $G$, then $G'$ is also a triangulation.  For this reason we say that an edge of $G$ that is not part of any separating triangle of $G$ is a \emph{contractible} edge.


\begin{cor}\label{good_edge_triangulation}
  Let $G$ be a triangulation with $n\ge 4$ vertices and outer face $f_0$, let $\mathcal{L}:=\langle L_i\rangle_{i\in\N}$ be an $S$-rooted BFS layering of $G$ and let $h$ be the height of $\mathcal{L}$.
  Then $G$ contains a contractible edge $uv$ with $u\in L_{h-1}$ and $v\in L_{h}$ such that
  \begin{compactenum}[(a)]
    \item $\deg_G(v)\le 4$, or
    \item $|N_G(u)\cap L_h|=1$.
  \end{compactenum}
\end{cor}

\begin{proof}
  If $G$ contains no separating triangle $xzy$ with $x\in L_{h-1}$ and $z\in L_h$ then the result follows immediately from \cref{good_edge}.

  Otherwise let $xyz$ be a separating triangle of $G$ with $x\in L_{h-1}$ and $z\in L_h$ that contains the fewest possible number of vertices of $G$ in its interior. Let $Z$ be the set of vertices of $G$ contained in the interior of $xyz$, let $Y:=\{x,y,z\}\cap L_{h-1}$, and let $G'$ be the graph obtained from $G[X\cup S]$ by adding an additional vertex $v$ adjacent to each vertex in $S$.  Observe that $\langle X,Y,Z\rangle$ is a $\{v\}$-rooted BFS layering of $G'$ so by \cref{good_edge}, it contains an edge $uv$ with $u\in\{Y\}\subseteq L_{h-1}$ and $v\in\{Z\}\subseteq L_h$ satisfying (\ref{low_degree}) or (\ref{only_child}). By the minimality of $xyz$, $uv$ is not part of any separating triangle in $G$, so $uv$ is a contractible edge of $G$'.
\end{proof}

% The following does't work
% We will assign each vertex $v\in L_h$ a \emph{parent} $\rho(v)$ as follows:  For each $v\in L_h$, let $\Rho(v):=\{N_G(v)\cap L_{h-1}\}$ be the set of \emph{possible parents} of $v$. Observe that $\Rho(v)$ is non-empty for each $v\in L_h$.  We proceed in two stages:
% \begin{enumerate}
%   \item Repeat the following operation as long as there exists a vertex $u\in L_{h-1}$ with exactly one neighbour, $v$, in $L_h$:
%   \begin{compactenum}
%     \item If $u\in\Rho(v)$ then set $\rho(v):=u$ and contract the edge $uv$.
%     \item If $u\not\in\Rho(v)$ then remove the edge $uv$ from $G$.
%   \end{compactenum}
%   \item Once this is no longer possible, complete the assignment by choosing, for each $v\in L_h$, an arbitrary vertex $u\in\Rho(v)$, and setting $\rho(v):=u$.  Note that \cref{good_edge_triangulation} implies that, by this point each vertex in $L_h$ has degree at most $4$.
% \end{enumerate}
%
% \todo[inline]{
%   Separating triangles are still an issue when we try to turn this into a contraction sequence.
% }


% \begin{lem}\label{contraction_sequence}
%   Let $G$ be a planar graph with $n\ge 2$ vertices, let $v$ be a vertex of $G$, let $\mathcal{L}:=\langle L_i\rangle_{i\in\N}$ be a $\{v\}$-rooted BFS layering of $G$ and let $h$ be the height of $\mathcal{L}$.
%   Then $G$ contains an edge $uv$ with $u\in L_{h-1}$ and $v\in L_{h}$ such that
%
%
%   Let $G$ be a planar graph triangulation with $n\ge 4$ vertices, let $f_0$ be the outer face of $G$, let $S\subseteq V(f_0)$, let $\mathcal{L}:=\langle L_i\rangle_{i\in\N}$ be the $S$-rooted BFS layering of $G$ and let $h$ be the height of $\mathcal{L}$.
%   Then there exists a sequence $S:=\langle u_iv_i\rangle_{i=1}^{|L_h|}$ of edges of $G$ that can be contracted, in order, to give a sequence of graphs $\langle G_i\rangle_{i=0}^{|L_h|}$ (with $G_0=G$ and $G_i$ the result of contracting edges $u_1v_1,\ldots,u_{i-1}v_{i-1}$) that has the following properties:
%   \begin{compactenum}[(i)]
%     \item $u_iv_i$ is a contractible edge of $G_{i-1}$; and
%     \item
%     \begin{compactenum}[(a)]
%       \item $\deg_{G_{i-1}}(v_i)\le 4$; or\label{low_degree2}
%       \item $\deg_{G_{i-1}}(v_i)> 4$, $|N_{G_i}(u_i)\cap L_{h-1}|=1$, and $u_i$ appears as an endpoint of exactly one edge in $S$.\label{only_child2}
%     \end{compactenum}
%   \end{compactenum}
% \end{lem}
%
% \begin{proof}
%   TODO
% \end{proof}

% Using \cref{good_edge} we can establish the following vertex ordering:

The last piece of the puzzle that we need is (something close to) the following lemma:

\begin{lem}\label{contraction_sequence}
    Let $G$, $f_0$, $S$, and $\mathcal{L}$ be as in the previous lemma.  Then there exists a sequence $\langle u_iv_i\rangle_{i=1}^{|L_h|}$ of edges of $G$ with the following properties:
    \begin{compactenum}
        \item $u_iv_i\in E(G_i)\cap E(G)$ for each $i\in\{1,\ldots,h\}$.
        \item $u_i\in L_{h-1}$ and $v_i\in L_h$ for each $i\in\{1,\ldots,|L_h|\}$.
        \item For each $i\in\{0,\ldots,|L_h|\}$, let $G_i$ be the graph obtained from $G$ after contracting $u_jv_j$ for each $j\in\{1,\ldots,i\}$.  Then, for each $i\in\{1,\ldots,|L_h|\}$,  $u_iv_i$ is contractible in $G_{i-1}$.
        \item For each $i\in\{1,\ldots,|L_h|\}$,
        \begin{compactenum}[(a)]
            \item $|N_{G_{i-1}}(v_i)\cap L_h\cap V(G_{i-1})|\le 2$ and
                $|N_{G_{i-1}}(v_i)\cap L_{h-1}\cap V(G_{i-1})|\le 2$; or
            \item $N_{G_{i-1}}(u_i)\cap L_h\cap V(G_{i-1})=\{v_i\}$.
        \end{compactenum}
    \end{compactenum}
\end{lem}

\begin{proof}
    I'm struggling to prove this because we need to avoid a situation in which the only edges we can find in $G_{i-1}$ are of type (\ref{only_child}) but none of those edges are actually edges of $G$.
\end{proof}

Finally, we'll use a BFS forest obtained by applying \cref{contraction_sequence} and adding all the edges $u_i,v_i$ to $F$ and the recursive on the graph $G_{|L_h|}$, whose BFS layering from $S$ only has height $h-1$.

% \begin{lem}\label{good_ordering}
%   Let $G$ be a triangulation with $n\ge 4$ vertices, let $f_0$ be the outer face of $G$, let $S\subseteq V(f_0)$, let $\mathcal{L}:=\langle L_i\rangle_{i\in\N}$ be the $S$-rooted BFS layering of $G$ and let $h$ be the height of $\mathcal{L}$.  Then there exists an $S$-rooted BFS spanning forest $F$ of $G$ and an ordering $v_0,\ldots,v_m$ on the vertices $G$ such that, for each $i\in\{0,\ldots,m\}$, $\depth_F(v_i)=\height(F-\{v_0,\ldots,v_{i-1}\}$ and
%   \begin{compactenum}[(a)]
%     \item The degree of $v_i$ in $G-\{v_0,\ldots,v_{i-1}\}$ is at most $4$; or
%     \item the parent of $v_i$ in $F-\{v_0,\ldots,v_{i-1}\}$ has only one child.
%   \end{compactenum}
% \end{lem}
%
% \begin{proof}
%
% \end{proof}

%
%
% \todo[inline]{This lemma, as stated, is not true.  If $Y_1$ and $Y_2$ form a cycle and $Y_3$ is a pendant vertex attached only to $Y_1$ then, after adding $Y_4$ there can be a face with all four sets on its boundary.  The issue is that, in this case $Y_1$ appears as two disconnected components on the facial walk of $G[Y_1\cup Y_2\cup Y_3]$.}
%
% \begin{lem}\label{tripod_blobs}
%   Let $G$ be an embedded planar graph, let $S:=Y_1\uplus Y_2\uplus Y_3\subseteq V(G)$ be such that $G[S]$ is connected, let $f$ be an internal face of $G[S]$ and let $Y_4\subseteq V(G)\setminus S$ such that $Y_4$ is in the interior of $f$, $G[Y_4]$ is connected, and, for each $i\in\{1,2,3\}$ such that $V(f)\cap Y_i$ is non-empty, there exists an edge $u_i,v_i$ of $G$ with $u_i\in Y_4$ and $v_i\in Y_i$.  Then, for each face $g$ of $G[S\cup Y]$, $V(g)\cap Y_j$ is empty, for at least one $j\in\{1,2,3,4\}$.
% \end{lem}
%
% \begin{proof}[Proof Sketch]
%   Consider the multigraph $M$ obtained from $G[S\cup Y]$ by contracting $Y_i$ for each $i\in\{1,2,3,4\}$, keeping parallel and edges and self-loops.  Since each $Y_i$ is connected, $M$ inherits a planar embedding from the embedding of $G$. For each $i\in\{1,2,3,4\}$, let $y_i$ be the vertex of $M$ obtained by contracting $Y_i$.  For each $i\in\{1,2,3\}$, the edge $u_iv_i$ in $G$ implies that $M$ contains at least one edge $e$ with endpoints $y_4$ and $y_i$.  Therefore, $M$ contains a subgraph isomorphic to the complete graph $K_4$ on four vertices, which is a triangulation.  Therefore each face of $M$ contains at most three vertices of $M$. The face $g$ has a corresponding face $g'$ in $M$ and, if $g$ contains a vertex of $Y_i$ then $g'$ contains $y_i$, for each $i\in\{1,2,3,4\}$. Since $g'$ contains at most three vertices of $M$, $g$ does not contain a vertex of $Y_i$ for some $i\in\{1,2,3,4\}$.
% \end{proof}

\section{Tripod Decompositions}


Let $G$ be a $n$-vertex triangulation, let $f_0$ be a face of $G$, let $S$ be a non-empty subset of $V(f_0)$ and let $\mathcal{L}:=\langle L_0,\ldots,L_h$ be a BFS layering of $G$ rooted at $S$.  A path $v_0,\ldots,v_r$ in $G$ is \emph{vertical} (with respect to $S$) if $\depth_\mathcal{L}(v_i)=\depth_{\mathcal{L}}(v_{i-1})-1$ for each $i\in\{1,\ldots,r\}$. The vertex $v_0$ is called the \emph{lower endpoint} of the vertical path and $v_r$ is the upper endpoint. A \emph{tripod} $Y$ is a subset of $V(G)$ whose vertices can be partitioned into three vertical paths in $G$.\footnote{Unlike \cite{dujmovic.joret.ea:planar}, we do not require that the lower endpoints of the three paths legs of a tripod form a triangular face in $G$.}
A tripod $Y$ is \emph{connected} if the induced subgraph $G[Y]$ is connected.  A \emph{(connected) tripod decomposition} $\mathcal{D}$ of $G$ (with respect to $S$) is a partition of $V(G)$ into (connected) tripods.  \citet{dujmovic.joret.ea:planar} proved the following result, which implies the planar product structure theorem:

\begin{thm}\label{tripod_decomposition}
  For any triangulation $G$, and face $f_0$ of $G$ and any $S\subseteq V(f_0)$, there exists a connected tripod decomposition $\mathcal{D}$ of $G$ (with respect to $S$) such that $\tw(G/\mathcal{D})\le 3$.
\end{thm}

% \begin{remark}
%   The result of \citett{dujmovic.joret.ea:planar} provides tripods with somewhat more structure.  Every tripod has three legs whose lower endpoints are on a common face of $G$.  It is possible to fix, in advance, an $S$-rooted BFS tree $T$ and produce tripods whose legs are paths in $T$.
% \end{remark}

\subsection{Tripod Decompositions from Face Orderings}

We now describe how tripod decompositions can be obtained from total orders on the faces of $G$.  Let $\mathcal{F}:=f_0,\ldots,f_{2n-3}$ be a total ordering of the faces of $G$.  Then $\mathcal{F}$ defines a tripod decomposition $\mathcal{D}_\mathcal{F}:=\{Y_0,\ldots,Y_{2n-3}\}$ with respect to $V(f_0)$ as follows:
\begin{compactenum}
  \item $Y_0$ is the tripod whose three paths are three vertices of $f_0$.
  \item For each $i\in\{0,\ldots,2n-2\}$, let $S_i:=\bigcup_{j=0}^i Y_j$.
  \item For each $i\in\{1,\ldots,2n-3\}$, let $x_{i,j}$, $j\in\{1,2,3\}$ denote the three vertices of $f_i$.
  \item For each $i\in\{1,\ldots,2n-3\}$, let $I_{i,j}$ be a vertical path in $F$ defined as follows.  If $x_{i,j}\in S$, then $I_{i,j}$ is empty.  Otherwise, the upper endpoint of $I_{i,j}$ is the minimum $F$-depth ancestor of $x_{i,j}$ that is not in $S$. The lower endpoint of $I_{i,j}$ is obtained by starting at $x_{i,j}$ and walking downward in $F$ as long as the current node has exactly one child and that child has degree at least $5$ in $G$.
  \item $Y_i:=I_{i,1}\cup I_{i,2}\cup I_{i,3}$.
\end{compactenum}
It is straightforward to verify from these definitions that $\mathcal{D}_\mathcal{F}$ is indeed a connected tripod decomposition of $(G,F)$.

For each $i\in\{0,\ldots,2n-3\}$, let $G_i:=G[\bigcup_{j=0}^iY_j]$.  A vertex $u$ in $G_{i-1}$ is a \emph{foot} of the tripod $Y_i$ if $u\in V(f_i)$ or if there exists an edge $uv$ of $G$ with $v\in Y_i$.  (Note that a tripod may have much more than three feet!)

% Don't need these anymore
% \todo[inline]{
%   Describe greedy face orderings.  These are orderings with the property that, if $f_i$ has an edge $xy$ with both $x$ and $y$ in $G_{i-1}$ then the next face of $G$ to appear in the face $f$ opposite $xy$ should be the other face with $xy$ on its boundary.  Make sure that whatever ordering we do is greedy.
% }

% For each $i\in\{1,\ldots,2n-3\}$ define the \emph{feet} of $Y_i$ as the set of vertices in $G_{i-1}$ adjacent to at least one vertex in $Y_i$.
% For each vertex $v$ of $G$, let $Y_v$ be the unique index $j$ such that $v\in Y_j$.

% \Cref{tripod_decomposition} can be obtained as a simple consequence of the next lemma. Informally, this lemma states that we can find an ordering $\mathcal{F}$ of $G$'s faces so that produces a tripod decomposition $\mathcal{D}_\mathcal{F}$ resulting in a sequence of connected graphs $G_0,\ldots,G_{2n-3}$ such that each face $f$ of each graph $G_j$ is bounded by at most three tripods in the set $Y_0,\ldots,Y_j$.  The connection between \cref{tripod_decomposition} and \cref{face_trick} is that, since each tripod $Y_j$ is contained in a face $f$ of $G_{j-1}$, this naturally defines a partial $3$-tree that contains $H:=G/\mathcal{D}$ where the parent clique of $Y_j$ in the $3$-tree contains the (at most) three tripods on the boundary of the face $f$.

\begin{lem}\label{face_trick}
  For any triangulation $G$, any face $f_0$ of $G$, and any $S\subseteq V(f_0)$ there exists an $S$-rooted BFS forest $F$ and an ordering $\mathcal{F}:=f_0,\ldots,f_{2n-3}$ of the faces of $G$ that defines a connected tripod decomposition $\mathcal{D}_\mathcal{F}:=Y_0,\ldots,Y_{2n-3}$ such that, for each $j\in\{0,\ldots,2n-3\}$ the tripod $Y_j$ has a foot in each tripod that contains a vertex on the face of $G_{j-1}$ whose interior  contains $Y_j$.
\end{lem}

\citet{dujmovic.joret.ea:planar} essentially prove \cref{face_trick} using a top-down approach, that constructs the face sequence $\mathcal{F}$ iteratively.  To find the face $f_i$, they consider some face $f\not\in\{f_0,\ldots,f_{i-1}$ of $G_{i-1}$ and use (\ref{three_faces}) and Sperner's Lemma to show that there is an appropriate face $f_i$ of $G$ that is contained in $f$.  \citet{morin:fast} later showed that this approach could be implemented in such a way that the resulting algorithm runs in $O(n\log n)$ time.  Below, we will now give an inductive proof of \cref{face_trick} that has a more bottom-up flavour and leads to an $O(n)$ time algorithm.   Before doing so, we first establish an easy consequence of \cref{face_trick} and \cref{tripod_blobs}.

\begin{lem}
  Let $G$, $S$, $\mathcal{F}$, $Y_0,\ldots,Y_{2n-3}$, and $G_0,\ldots,G_{2n-3}$ be defined as in \cref{face_trick}. Then, for each $i\in\{0,2n-3\}$, each face of $G_i$ contains vertices of at most three tripods in $Y_0,\ldots,Y_{2n-3}$.
\end{lem}

\begin{proof}
  The proof is by induction on $i$.  The base case $i=0$ is trivial since $G_0=f_0$ has three vertices.  Now assume $i\ge 1$. Let $g$ be any face $G_i$.  If $g$ is also a face of $G_{i-1}$ then the inductive hypothesis implies the result.  Otherwise, $g$ contains at least one vertex of the tripod $Y_i$.  The tripod $Y_i$ is contained in the interior of some face $f$ of $G_{i-1}$.  The inductive hypothesis implies that $f$ contains vertices of $c\le 3$ tripods among $Y_{0},\ldots,Y_{i-1}$.  If $c\le 2$ then $g$ contains vertices of $Y_i$ and at most two tripods in $Y_0,\ldots,Y_{i-1}$, as required.  If $c=3$ then \cref{tripod_blobs} establishes the result.
\end{proof}




% , but first we need the following lemma:
%
% \begin{lem}\label{good_deep_edge}
%   If $n\ge 4$, then $F$ contains an edge $uv$ such that
%   \begin{compactenum}[(i)]
%     \item\label{max_depth} $\depth_{F}(v)=\height(F)$; and
%     \item\label{no_separating_triangle} there is no $w\in V(G)$ such that $G-\{u,v,w\}$ is disconnected.
%   \end{compactenum}
% \end{lem}
%
% \begin{proof}
%   Let $v$ be any leaf of $F$ having depth $k:=\height(F)$ and let $u$ be the $F$-parent of $v$.  By definition, $uv$ satisfies (\ref{max_depth}).  If $uv$ also satisfies (\ref{no_separating_triangle}) then there is nothing to prove.  Assume therefore that $uv$ is part of some $3$-cycle $uvw$ in $G$ such that $G-\{u,v,w\}$ is disconnected with one component $X$ in the interior of $uvw$ and the other component $Y$ in the exterior of $uvw$.
%
%   The triple $(u,v,w)$ has the following properties:
%   \begin{inparaenum}[(a)]
%       \item $\depth_F(v)=k$;
%       \item $u$ is the $F$-parent of $v$;
%       \item and there exists $w$ such that $G-\{u,v,w\}$ is disconnected with one component $X$ in the interior of the cycle $uvw$.
%   \end{inparaenum}
%   If $(G,F)$ has more than one triple $(u,v,w)$ satisfying the preceding conditions, then choose a \emph{minimal} triple in the sense that there does not exist $(u',v',w')$ that also satisfy these conditions and such that the component $X'$ of $G-\{u',v',w'\}$ contained in the interior of the cycle $u'v'w'$ has fewer vertices than $X$.
%
%   Since $\depth_F(u)=k-1$, $\depth_F(v)=k$ and $w$ is adjacent to both $u$ and $v$, $\depth_{F}(w)\in\{k-1,k\}$.
%   Let $v'$ be any vertex of $X$. Then $\depth_F(v')\le\height(F)\le k$ and $\depth_F(v')\ge 1+\min\{\depth_F(y):y\in\{u,v,w\}\}=k$, so $\depth_{F}(v')=k$ and the $F$-parent $u'$ of $v'$ is one of $u$ or $w$.  We claim that, in either case, the edge $u'v'$ satisfies the conditions of the lemma.  By definition, $u'v'$ satisfies (\ref{max_depth}).  To see that it also satisfies (\ref{no_separating_triangle}), observe that, if there exists $w'$ such that $G-\{u',v',w'\}$ is disconnected with a component $X'$ in the interior of $u'v'w'$ than $V(X')\subseteq V(X)\setminus\{v'\}$, so $|V(X')|<|V(X)|$, which violates the minimality of $(u,v,w)$.
% \end{proof}

% We can now prove give a bottom-up proof of \cref{face_trick}.

\begin{proof}[Proof of \cref{face_trick}]
  The proof is by induction on $n$, the number of vertices of $G$.  If $n=3$, the proof is trivial: Set $f_1$ to be the only inner face of $G$.  Then $Y_0=V(G_0)= V(G_1)$ and $Y_1$ is empty.  Assume therefore that $n\ge 4$ and that the statement of the lemma is true for any graph with fewer than $n$ vertices.

  Let $S:=\langle u_iv_i\rangle_{i=1}^{|L_h|}$ be the sequence of edges given by \cref{contraction_sequence}.  We put these edges into the BFS forest $F$ we are constructing.  We then contract these edges and repeat this process on the resulting graph to obtain our BFS forest $F$ and an ordering of the edges of $F$ that gives a contraction sequence $S$ with some properties we want.  Let $uv$ be the first edge in $S$ and let $G'$ and $F'$ be obtained by contracting $uv$ in $G$ and $F$, respectively.

  Since $uv$ is a contractible edge of $G$, $G'$ is a triangulation.  Since $\depth_F(v)=\height(F)$, $F'$ is an $S$-rooted BFS tree of $G'$.  Recurse on $G'$, $F'$, and the suffix $S'$ obtained by removing $uv$ from $S$. The result is an ordering of $\mathcal{F}':=f_0,\ldots,f_{2n-5}$ of the faces of $G'$ such that the tripod sequence $\mathcal{D}_{F'}:=Y_0',\ldots,Y_{2n-5}'$ and the resulting sequence of induced subgraph $G_0',\ldots,G_{2n-5}'$ satisfy the conditions of the lemma.

  Each face of $G'$ not incident to $u$ is also a face of $G$.  Each face of $G'$ incident to $u$ corresponds to a face of $G$ that is incident to exactly one of $u$ or $v$.  Therefore, the ordering $\mathcal{F}':=f_0',\ldots,f_{2n-5}'$ on the faces of $G$ defines an ordering $f_0,\ldots,f_{2n-5}$ on all but two faces of $G$.  In particular, it does not include the two faces $f'$ and $f''$ of $G$ that contain the edge $uv$. We now show that it is possible to insert $f'$ and $f''$ into the ordering $f_0,\ldots,f_{2n-5}$ to obtain an ordering of the faces of $G$ that satisfies the conditions of the lemma.

  \begin{enumerate}
    \item $\deg_G(v)>4$.  In this case, $u$ has only one child in the tree $T$ and no children in $T'$.  Now $u$ is a vertex of $G'$ so $u$ appears in some tripod $Y_i'$ that corresponds to some face $f_i'$ of $G'$.  Since $u$ has no children in $T'$, $u$ is the bottom vertex in the leg of $Y_i'$ that contains $u$.  In this case $Y_i:=Y_{i}'\cup\{v\}$ and $Y_{\ell}=Y_\ell'$ for each $\ell\in\{0,\ldots,2n-5\}\setminus\{i\}$.

    % \begin[inline]{todo}
    %   Specify locations of $f'$ and $f''$.  I think moving $f'$ immediately after the first $f_i$ for which $G_i$ contains all three vertices of $f'$ works.
    % \end{todo}

    Now, the feet of $Y_i$ are exactly the same as the feet of $Y_i'$ and a tripod $Y_j'=Y_j$ with a foot in $Y_i'$ also has a foot in $Y_i$, so this satisfies the conditions of the lemma.

    \item $\deg_G(v)=4$.  In this case we consider the tripod $Y_i'$ that contains $u$.  $Y_i'$ corresponds to a face $f_i'$ of $G'$ and $f_i'$ corresponds to a face $f_i$ of $G$.  We distinguish between two cases:
    \begin{compactenum}
      \item If $f_i$ is not incident to $v$, then consider the minimum $r$ such that $f_r$ is incident to $v$. Such an $r$ must exist because $v$ is incident on at least $3$ faces of $G$ and at least one of these faces has a corresponding face in $G'$.  By definition $r\neq i$ and $r\not\le i$ since, otherwise $u$ would be part of $Y_r$.

      In this case $Y_r:=Y_r'\cup\{v\}$ and $Y_{\ell}=Y_\ell'$ for each $\ell\in\{0,\ldots,2n-5\}\setminus\{r\}$.  For each $j\in\{0,\ldots,r-1\}$, the feet of $Y_j$ in $G_{j-1}$ are the same as the feet of $Y_j'$ in $G_{j-1}'$, so there is nothing to worry about there.

      For $Y_r$, there are two cases to consider.
      \begin{compactenum}
        \item  If $Y_r'$ is empty then all three vertices of $f_r$ are in $G_{r-1}$ and all of them are feet.  In $G$, $v$ is adjacent to each vertex of $f_r$, so the feet of $Y_r$ are a superset of the feet of of $Y_r'$.

        For $Y_j$ with $j>r$, we have to be a bit careful.  One of the non-triangular faces of $G_{r}$ incident on $v$ has $Y_r$ on its boundary.  In $G_{r}'$, this face had at most two tripods on its boundary, the tripod $Y_i$ containing $u$ and the tripod $Y'$ containing the neighbour of $v$.  When an additional tripod appears, it may or may not put a foot on $Y_r$.  This would be bad!  So let's rely instead on the greedy property that is mentioned above.  This property say that if the triangle opposite $f_r$ did not already appear before $f_r$, then it will be the first triangle to appear inside $f$.  That tripod definitely has a foot on $f_r$, phew!.

        \item If $Y_r'$ has one vertex $w$ of $f_r'$ and $uw\in E(G)$. Do some case analysis\ldots

        \item If $Y_r'$ has one vertex $w$ of $f_r'$ and $uw\not\in E(G)$. [Tricky case, requires moving $f'$ or $f''$ forward to preserve the greedy property.]

        \item If $Y_r$ has two vertices of $f_r'$, then this is a clean one.
      \end{compactenum}
    \end{compactenum}

      \item If $f_i$ is incident to $v$, then $v\in Y_i$ and things are easy.
  \end{enumerate}

  %
  % '
  %
  %
  %
  % \begin{enumerate}
  %   \item $\deg_{G_i}(v_i)>4$.
  %
  %
  %
  %   \item $\deg_{G'_j}(v_j)=3$ then we create a new tripod that contains only $v$.  This creates three new faces
  %
  %
  %     Then there is one face $f_i$ of $G'_j$ that is incident to $v$ and that corresponds to a face $f_i'$ in $G'_{j+1}$ that is incident to $u$.  We add $v$ to the tripod $Y_i$.
  %
  %
  %
  %    Now there are two cases to consider:
  %   \begin{compactenum}
  %     \item $u\in Y_i$ then
  %
  %
  %   \item $\deg_{G'_j}(v_j)= 4$.  Consider the tripod $Y_i$ that contains $u_i$
  %
  %
  %
  % \end{enumerate}
  %
  %
  % $n-1$ vertices.
  %
  % Let $uv\in E(G)$ be an edge of $G$ satisfying the conditions of \cref{good_edge}.  If $uv$ is part of a separating triangle $uvw$ then [handle separating triangles separately]\todo{Or avoid those edges if possible.} Let $G'$ and $F'$ be obtained by contracting the edge $uv$ in $G$ and $F$, respectively. We use the convention that $G'$ and $F'$ contain the vertex $u$ but not $v$ so that $N_{G'}(u)=N_G(u)\cup N_G(v)$ and $N_{F'}(u)=N_F(u)\cup N_F(v)$.  Observe that $G'$ is a triangulation on $n-1$ vertices and $F$ is a BFS forest of $G'$ rooted at the vertices of $f_0$.   Apply the inductive hypothesis to obtain an ordering $\mathcal{F}':=f_0,\ldots,f_{2n-5}$ of the faces of $G'$ that satisfies the conditions of the lemma.
  %
  % Each face of $G'$ not incident to $u$ is also a face of $G$.  Each face of $G'$ incident to $u$ corresponds to a face of $G$ that is incident to exactly one of $u$ or $v$.
  % % Because of this, there is no need to distinguish between a face that is in $G'$ and the corresponding face in $G$.
  % Therefore, the ordering $\mathcal{F}':=f_0',\ldots,f_{2n-5}'$ on the faces of $G$ defines an ordering $f_0,\ldots,f_{2n-5}$ on all but two faces of $G$.  In particular, it does not include the two faces $f_{2n-4}$ and $f_{2n-3}$ of $G$ that contain the edge $uv$.
  %
  % We claim that the ordering $\mathcal{F}:=f_0,\ldots,f_{2n-3}$ satisfies conditions (\ref{biconnected}) and (\ref{three_faces}). To prove this claim, consider the unique tripod $Y_i'$ in the tripod decomposition $\mathcal{D}_{\mathcal{F'}}:=Y_0',\ldots,Y_{2n-3}'$ that contains $u$. For each $j\in\{0,\ldots,i-1\}$, $G_j=G_j'$ and $Y_j=Y_j'$ so it suffices to check conditions (\ref{biconnected}) and (\ref{three_faces}) for $j\in\{i,\ldots,2n-3\}$. Furthermore, $G_{2n-3}=G_{2n-4}=G_{2n-5}$, so it suffices to verify (\ref{biconnected}) and (\ref{three_faces}) for $j\in\{i,\ldots,2n-5\}$.
  %
  %
  % Now there are two cases to consider:
  %
  % \begin{enumerate}
  %   \item The face $f_i$ is incident to $v$ (and not $u$) in $G$. See \cref{replacement}.
  %   \begin{figure}
  %     \begin{center}
  %       \begin{tabular}{cc}
  %         \includegraphics{figs/case1-1} & \includegraphics{figs/case1-2}
  %       \end{tabular}
  %     \end{center}
  %     \caption{Case 1 in the proof of \cref{face_trick}}
  %     \label{replacement}
  %   \end{figure}
  %
  %   In this case we claim that $G_j'=G_j/uv$ for each $j\in\{0,\ldots,2n-5\}$. That is, $G_j'$ is obtained from $G_j$ by contracting the edge $uv$ into $u$.  To prove this, it suffices to show that $\overline{Y}_j'=\overline{Y}_j$ for each $j\in\{0,\ldots,2n-5\}$ since this implies that
  %   \[
  %     G_j/uv = (G_{j-1}\cup\overline{Y}_j)/uv=(G_{j-1}/uv) \cup (\overline{Y}_j/uv) = G_{j-1}'\cup \overline{Y}_j' = G_j' \enspace .
  %   \]
  %
  %   Above, we have already argued that $G_j=G_j'$, $Y_j=Y_j'$, and $\overline{Y}_j=\overline{Y}_j'$ for each $j\in\{0,\ldots,i-1\}$, so the first interesting case occurs when $j=i$.  We will finish the proof of the claim by induction on $j\ge i$. The case $j=i$ is special.  Since $f_i$ is incident on $v$, $v$ is contained in the tripod $Y_i$.  Indeed, $Y_i$ is identical to $Y_i'$ except that the leg with bottom vertex $u$ is extended so that its bottom vertex is $v$. Therefore $Y_i'=Y_i/uv$.
  %
  %   Suppose $j\ge i$ and consider the face $f'$ of $G_{j-1}'$ that contains $f_j'$.  By the inductive hypothesis, there is a face $f$ of $G_{j-1}$ that corresponds to $f'$. The tripods $Y_j$ and $Y_j'$ are identical; each contains three maximal vertical paths from the vertices of $f'_j=f_j$ up to, but not including the first vertex in $f'$, respectively $f$.  The closures $\overline{tau}_j$ and $\overline{Y}_j'$ of these tripods are also identical except that, possibly the vertex $u$ appears as a foot in one leg of $\overline{Y}_j'$ but is replaced by $v$ in $\overline{Y}_j$.  Nevertheless $\overline{Y}_j'=Y_j/uv$, as required.  This completes the proof that $G_j'=G_j/uv$.
  %
  %   Since $G$ contains no separating triangle with the edge $uv$, neither does $G_j$.  It now follows that $G_j$ is biconnected since $G_j'=G_j/uv$ is biconnected, so $G_j$ satisifies (\ref{biconnected}).
  %
  %   Since $G_j'=G_j/uv$, there is an injective function from the faces of $G_j'$ onto the faces of $G_j$.  Therefore, for any face $f\not\in\{f_{2n-3},f_{2n-4}\}$ of $G_j$ there is a corresponding face $f'$ of $G_j'$.  It is straightforward to verify that $J_\mathcal{F}(f)=J_\mathcal{F'}(f')$ and therefore $f$ satisfies (\ref{three_faces}) since $f'$ satisfies (\ref{three_faces}).
  %
  %   \item The face $f_i$ is not incident to $v$ in $G$.  Since $v$ is a leaf of $F$, this implies that $v\not\in Y_j$ for any $j\in\{0,\ldots,i\}$.  In fact, $v$ is the bottom vertex of the leg of the tripod $Y_r$ that contains $v$.  In particular, $v\in Y_r$ for the minimum $r$ such that $f_r$ is incident to $v$ in $G$.  Note that this implies $r\ge i$ since otherwise $u$ would already be included in $Y_r'$ and not in $Y_i'$. Case~1 above considers the case $i=r$.  Furthermore, $r\le 2n-5$, since  $f_{2n-4}$ and $f_{2n-3}$ account for only two of the at least three faces of $G$ incident to $v$.  Therefore $r\in\{i+1,\ldots,2n-5\}$ and $Y_r'$ is a tripod with one empty leg whose foot is $u$.
  %
  %   Again, we claim that $G_j'=G_j/uv$ for each $j\in\{0,2n-5\}$.  The proof of this claim is similar to the previous case except that we already know that $G_j=G_j'$ for each $j\in\{0,\ldots,r-1\}$, so the first interesting case occurs when $j=r$. This case is handled easily because, from the discussion in the preceding paragraph $\overline{Y}_r'=\overline{Y}_r/uv$.  The cases in which $j\in\{r+1,\ldots,2n-5\}$ are handled as in the previous case.
  %
  %   As in the previous case, the fact that $G$ has no separating triangle with the edge $uv$ implies $G_j$ is biconnected since $G_j'=G_j/uv$ is biconnected, so $G_j$ satisifies (\ref{biconnected}).
  %
  %
  %   \todo[inline]{This is now broken.  The problem occurs at the first $s>r$ such that $f_s$ is incident on $v$.  Essentially, the face $f_s'$ was chosen because it gives a tripd $Y_s'$ that has feet on $Y_i'$, $Y_r'$ and $Y_q'$ for some $q$.  But now $Y_s$ has two feet on $Y_r$ and no feet on $Y_i$.  This seems to fuck everything up.  The only obvious observation here is that $f_s$ should be one of the triangles incident on $v$, which could help if we can guarantee that $v$ has low degree.  The problem seems to go away if $v$ has degree at most $5$, and looks}
  %
  %
  %   Now consider any face $f$ of $G_j$ for some $j\in\{r,\ldots,2n-5\}$.  If $f$ contains no edge of $\overline{Y}_r$ and no vertex of $\overline{Y}_r$.
  %
  %   Now consider the face $f$ of $G_{r-1}$ that contains $f_r$.  Assume, for now that $|J_{\mathcal{F'}}(f)|=3$.  Since $u\in V(f)$, $J_{\mathcal{F'}}(f)$ contains $i$ as well as two other values $i_1,i_2$.  The graph $f\cup\overline{Y}_r\subseteq G_r$ has the face $f_r$ and up to three additional internal faces $g$, $g_2$, and $g_3$.  Assume, for now that $f\cup\overline{Y}_r'\subseteq G_r'$ contains three corresponding faces $g'$, $g_1'$ and $g_2'$.  Now, $|J_{\mathcal{F'}}(g')|\le 3$, and
  %
  %
  %
  %
  %
  %
  %   \todo{define foot of a tripod}.  In $Y_r$ this leg contains the length-$0$ path that contains only $v$.  We now verify that $\mathcal{F}$ satisfies conditions (\ref{biconnected}) and (\ref{three_faces}).  This verification is similar to the verification in the first case, except for the proof that $\mathcal{F}$ satisfies (\ref{three_faces}) for a face $f$ that contains $v$.
  %
  %   Let $f$ be a face of $G$ that contains $v$.  If $|J_{\mathcal{F}'}(f)|\in\{1,2\}$ then $|J_{\mathcal{F}}(f)|\le 3$ and its easy since $J_{\mathcal{F}}(f)\subseteq J_{\mathcal{F'}}(f)\cup\{r\}$.  If $f$ also contains $u$ then it contains the edge uv and [argue that we can swap an element of $J_{\mathcal{F}'}(f)$ for $r$].  If $f$ does not contain $u$ then [argue that we can swap $i$ out of $J_{\mathcal{F}'}(f)$ and use $r$ instead.]  \qedhere
  % \end{enumerate}
\end{proof}


\section{A Linear Time Algorithm}


\bibliographystyle{plainurlnat}
\bibliography{ps2}


\end{document}
